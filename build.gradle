// Initial gradle configuration
// TODO Separate gradle build files
buildscript {
    ext {
        springBootVersion   = "2.0.2.RELEASE"
        dockerPluginVersion = "3.2.4"
        nodePluginVersion   = "1.2.0"

        bootstrapVersion    = "4.1.0"
        mariaVersion        = "2.2.5"
    }

    repositories {
        jcenter()
        mavenCentral()
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }

    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
        classpath("com.bmuschko:gradle-docker-plugin:${dockerPluginVersion}") // TODO Apply docker-plugin fully
        classpath("com.moowork.gradle:gradle-node-plugin:${nodePluginVersion}")
    }
}

def nodeVersion = "10.5.0"
def npmanagerVersion = "6.1.0"

apply plugin: "java"
apply plugin: "idea"
apply plugin: "org.springframework.boot"
apply plugin: "io.spring.dependency-management"
apply plugin: "com.moowork.node"

repositories {
    mavenCentral()
}

dependencies {
    compile("org.springframework.boot:spring-boot-starter-web")
    compile("org.springframework.boot:spring-boot-starter-thymeleaf")
    // compile("org.springframework.boot:spring-boot-starter-security") // TODO Add this after configuration for initial settings
    compile("org.springframework.boot:spring-boot-devtools")
    compile("org.springframework.boot:spring-boot-starter-data-jpa")
    compile("org.springframework.boot:spring-boot-starter-data-rest")

    // compile("org.thymeleaf.extras:thymeleaf-extras-springsecurity4:3.0.2.RELEASE")
    compile("org.webjars:bootstrap:${bootstrapVersion}") // TODO Initial styles. Probably should change to our"s
    compile("org.mariadb.jdbc:mariadb-java-client:${mariaVersion}")

    testCompile("org.springframework.boot:spring-boot-starter-test")
}

sourceCompatibility = 1.8
targetCompatibility = 1.8

version = "0.0.1"

jar {
    manifest {
        attributes "Implementation-Title": "Packaged webapp",
                "Implementation-Version": version,
                "Main-Class": "com.multiheaded.webapp.Application"
    }

    from {
        configurations.compile.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

bootJar {
    baseName = "com.multiheaded.webapp"
}

task copyDockerJar(type: Copy) {
    from "build/libs"
    into ".docker/webapp"
    rename "(.*).jar", "app.jar"
}

// TODO ADD npm scripts
// https://objectpartners.com/2016/04/22/using-webpack-with-gradle/
// https://guides.gradle.org/running-webpack-with-gradle/#step_1_2_install_webpack_and_lodash
// https://github.com/srs/gradle-node-plugin

node {
    version = nodeVersion
    npmVersion = npmanagerVersion
    download = true
}